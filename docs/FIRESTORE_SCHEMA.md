# Firestore Data Model Schema for Al Huzaifa Digital

## Overview
This document defines the complete Firestore database schema with relational links between collections.

---

## 1. BILLS Collection (`bills`)

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  billNo: string,                    // Unique bill number (e.g., "BILL-001")
  customerName: string,              // Customer name
  mobile: string,                    // Customer mobile number
  orderDate: Timestamp,              // Order date
  deliveryDate: Timestamp,           // Expected delivery date
  items: Array<{
    id: string,                      // Unique item ID (UUID)
    itemName: string,                // Item name
    originalRate: number,            // Original rate before VAT
    vat: number,                     // 5% VAT amount
    totalWithVat: number,            // Rate + VAT
    ready: boolean,                  // Item ready status
    assignedWorkerId: string | null, // Reference to worker document ID (if assigned)
    assignedAt: Timestamp | null      // When item was assigned
  }>,
  calculations: {
    sumOriginalRates: number,       // Sum of all original rates
    sumTotalVat: number,             // Sum of all VAT amounts
    grandTotal: number,              // Sum Rates + Sum VAT
    advancePayment: number,          // Advance payment received
    pendingAmount: number            // Grand Total - Advance Payment
  },
  status: {
    delivered: boolean,              // Bill delivered status
    fullPayment: boolean             // Full payment received
  },
  isFavourite: boolean,              // Starred customer
  createdAt: Timestamp,              // Bill creation timestamp
  updatedAt: Timestamp,              // Last update timestamp
  createdBy: string                  // User email/ID (for multi-user support)
}
```

**Indexes Required**:
- `deliveryDate` (Ascending)
- `status.delivered` (Ascending)
- `customerName` (Ascending)
- `mobile` (Ascending)
- `billNo` (Ascending)

---

## 2. WORKERS Collection (`workers`)

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  name: string,                      // Worker name
  contact: string,                   // Worker contact number
  assignedItems: Array<{
    billId: string,                  // Reference to bill document ID
    itemId: string,                  // Reference to item ID within the bill
    billNo: string,                  // Bill number (for quick access)
    itemName: string,                // Item name
    deliveryDate: Timestamp,         // Delivery date from bill
    workerRate: number,              // Rate paid to worker for this item
    sentToWorker: boolean,           // Checkbox: Sent to worker
    receivedFromWorker: boolean,     // Checkbox: Received from worker
    assignedAt: Timestamp           // When item was assigned
  }>,
  payments: Array<{
    amount: number,                  // Payment amount
    date: Timestamp,                 // Payment date
    notes: string                    // Optional notes
  }>,
  calculations: {
    totalPayable: number,            // Sum of all worker rates
    totalPaid: number,              // Sum of all payments
    balance: number                 // Total Payable - Total Paid
  },
  createdAt: Timestamp,
  updatedAt: Timestamp,
  createdBy: string
}
```

**Indexes Required**:
- `name` (Ascending)
- `createdAt` (Descending)

---

## 3. FAVOURITE_CUSTOMERS Collection (`favouriteCustomers`)

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  customerName: string,              // Customer name
  mobile: string,                    // Customer mobile
  measurements: {
    length: string | null,
    shoulder: string | null,
    chest: string | null,
    sleeve: string | null,
    hip: string | null,
    neck: string | null,
    waist: string | null,
    // Add 3 more custom fields as needed
    custom1: string | null,
    custom2: string | null,
    custom3: string | null
  },
  billIds: Array<string>,            // Array of bill document IDs for this customer
  createdAt: Timestamp,
  updatedAt: Timestamp,
  createdBy: string
}
```

**Indexes Required**:
- `customerName` (Ascending)
- `mobile` (Ascending)

---

## 4. SAMPLES Collection (`samples`)

**Document ID**: Auto-generated by Firestore

**Fields**:
```typescript
{
  name: string,                      // Sample design name
  rate: number,                      // Sample rate
  imageUrl: string,                  // Firebase Storage URL
  imagePath: string,                 // Storage path
  soldOut: boolean,                  // Availability status
  createdAt: Timestamp,
  updatedAt: Timestamp,
  createdBy: string
}
```

**Indexes Required**:
- `soldOut` (Ascending)
- `createdAt` (Descending)

---

## 5. PROFITS Collection (`profits`) - Optional for Dashboard

**Document ID**: `YYYY-MM` format (e.g., "2024-03")

**Fields**:
```typescript
{
  month: string,                     // "YYYY-MM"
  year: number,                      // Year
  monthlyProfit: number,            // Total profit for the month
  totalBills: number,               // Number of bills in month
  totalRevenue: number,              // Total revenue
  totalExpenses: number,             // Total expenses (worker payments, etc.)
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

---

## Relational Links

### Bills ↔ Workers
- **Link**: `bills.items[].assignedWorkerId` → `workers.{documentId}`
- **Reverse Link**: `workers.assignedItems[].billId` → `bills.{documentId}`
- **When assigning**: Update both documents atomically using a batch write

### Bills ↔ Favourite Customers
- **Link**: `favouriteCustomers.billIds[]` → `bills.{documentId}`
- **When starring**: Add bill ID to customer's `billIds` array

---

## Data Integrity Rules

1. **Bill Assignment to Worker**:
   - When "Share" is clicked on an item, create/update worker document
   - Add item to `workers.assignedItems[]`
   - Set `bills.items[].assignedWorkerId` and `assignedAt`

2. **Calculations**:
   - Always recalculate `calculations` object when items change
   - Use Firestore transactions for atomic updates

3. **Bill Number Generation**:
   - Format: `BILL-{YYYY}-{NNN}` (e.g., "BILL-2024-001")
   - Use a counter collection to track sequence

4. **Timestamps**:
   - Always use Firestore `Timestamp` type (not JavaScript Date)
   - Set `updatedAt` on every write operation

---

## Security Rules (Firestore)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Bills: Users can only access their own bills
    match /bills/{billId} {
      allow read, write: if request.auth != null;
    }
    
    // Workers: Users can only access their own workers
    match /workers/{workerId} {
      allow read, write: if request.auth != null;
    }
    
    // Favourite Customers: Users can only access their own
    match /favouriteCustomers/{customerId} {
      allow read, write: if request.auth != null;
    }
    
    // Samples: Users can only access their own
    match /samples/{sampleId} {
      allow read, write: if request.auth != null;
    }
  }
}
```

---

## Indexes to Create in Firebase Console

1. Collection: `bills`
   - `deliveryDate` (Ascending)
   - `status.delivered` (Ascending) + `deliveryDate` (Ascending)
   - `customerName` (Ascending)
   - `mobile` (Ascending)

2. Collection: `workers`
   - `name` (Ascending)
   - `createdAt` (Descending)

3. Collection: `favouriteCustomers`
   - `customerName` (Ascending)
   - `mobile` (Ascending)
